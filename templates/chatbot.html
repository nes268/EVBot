<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot | EVBot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background: #121212;
            min-height: 100vh;
            color: #e0e0e0;
            font-family: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 24px;
            position: relative;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(34, 197, 94, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 159, 10, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .navbar { 
            background: rgba(18, 18, 18, 0.8) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            padding: 15px 0;
            border-radius: 12px;
            margin: 0 20px 30px 20px;
            position: relative;
            z-index: 1;
        }
        
        .navbar-brand { 
            font-weight: 700;
            font-size: 1.5em;
            color: #22C55E !important;
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        .navbar .nav-link { 
            color: #e0e0e0 !important;
            margin: 0 15px;
            transition: all 0.3s ease;
            font-weight: 500;
            border-radius: 8px;
            padding: 8px 15px !important;
        }
        
        .navbar .nav-link:hover {
            color: #3B82F6 !important;
            background: rgba(59, 130, 246, 0.1);
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .page-wrapper {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 20px 0 40px;
            overflow-y: auto;
        }

        .chat-container {
            width: min(900px, 100%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            z-index: 1;
            margin: 0 auto 24px;
            padding: 0 24px;
        }

        .page-title {
            text-align: center;
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            color: #3B82F6;
            margin: 20px 0 30px 0;
        }

        .chat-window {
            background: rgba(18, 18, 18, 0.9);
            backdrop-filter: blur(24px);
            border-radius: 24px;
            padding: 28px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            min-height: clamp(520px, 65vh, 680px);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
            max-width: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 22px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: rgba(12, 12, 12, 0.65);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .message {
            padding: 14px 20px;
            border-radius: 18px;
            max-width: min(75%, 540px);
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
            line-height: 1.55;
        }

        .message.user {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            align-self: flex-end;
            color: #e0e0e0;
        }

        .message.bot {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            align-self: flex-start;
            color: #e0e0e0;
        }

        .chat-input-container {
            display: flex;
            gap: 14px;
            padding: 16px 18px;
            background: rgba(12, 12, 12, 0.7);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .chat-input {
            flex: 1;
            padding: 16px 20px;
            border: 1.5px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            background: rgba(24, 24, 24, 0.8);
            color: #f3f3f3;
            font-family: 'Inter', sans-serif;
            font-size: 1.02em;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.1),
                0 0 20px rgba(59, 130, 246, 0.3);
            background: rgba(18, 18, 18, 0.8);
        }

        .send-button {
            padding: 16px 32px;
            background: linear-gradient(135deg, #3B82F6, #22C55E);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: 'Poppins', sans-serif;
        }

        .send-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 32px rgba(34, 197, 94, 0.4);
        }

        .send-button:disabled {
            background: rgba(59, 130, 246, 0.3);
            cursor: not-allowed;
            transform: none;
        }

        .suggestions {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 12px;
            padding: 0 12px;
            overflow-x: auto;
            scrollbar-width: thin;
            -webkit-overflow-scrolling: touch;
        }

        .suggestion-btn {
            padding: 10px 18px;
            background: rgba(59, 130, 246, 0.12);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 20px;
            color: #7cb9ff;
            font-size: 0.92em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            box-shadow: none;
        }

        .suggestion-btn:hover {
            background: rgba(59, 130, 246, 0.22);
            border-color: #3B82F6;
            transform: translateY(-2px);
            box-shadow: none;
        }

        .model-assist {
            background: rgba(12, 12, 12, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            padding: 18px 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .model-assist-header {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .model-assist-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: #cbd5f5;
            cursor: pointer;
        }

        .assist-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .read-aloud-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            color: #cbd5f5;
        }

        .read-aloud-toggle input {
            width: 18px;
            height: 18px;
            accent-color: #22C55E;
        }

        .model-assist-toggle input {
            width: 18px;
            height: 18px;
            accent-color: #3B82F6;
        }

        .model-assist-hint {
            display: none;
        }

        .model-assist-form[hidden] {
            display: none;
        }

        .model-assist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px 18px;
        }

        .model-input label {
            display: block;
            font-size: 0.85em;
            color: #a5b4fc;
            margin-bottom: 6px;
        }

        .model-input input,
        .model-input select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(18, 18, 18, 0.8);
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .model-input input:focus,
        .model-input select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            .page-wrapper {
                padding: 12px 0 24px;
            }
            .page-title {
                font-size: 1.8em;
                margin-bottom: 12px;
            }
            .message {
                max-width: 100%;
            }
            .navbar {
                margin: 0 0 18px;
                padding: 12px 18px;
            }
            .chat-window {
                padding: 22px 18px;
                min-height: 520px;
            }
            .chat-input-container {
                flex-direction: column;
            }
            .send-button {
                width: 100%;
                justify-content: center;
            }
            .assist-controls {
                width: 100%;
                justify-content: flex-start;
            }
            .model-assist {
                padding: 16px;
            }
            .model-assist-grid {
                grid-template-columns: 1fr;
            }
            .model-assist-hint {
                display: none;
            }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">EVBot</a>
    <div class="d-flex">
      <a class="nav-link" href="/">Home</a>
      <a class="nav-link" href="/predict">Check Charge</a>
      <a class="nav-link" href="/dashboard">Dashboard</a>
      <a class="nav-link" href="/chatbot">Chatbot</a>
    </div>
  </div>
</nav>

<div class="page-wrapper">
    <div class="chat-container">
        <h1 class="page-title">EVBot Assistant</h1>

        <div class="chat-window">
            <div class="suggestions" id="suggestions">
                <button class="suggestion-btn" onclick="sendSuggestion('How do I improve battery health?')">Battery Health Tips</button>
                <button class="suggestion-btn" onclick="sendSuggestion('What is optimal charging?')">Charging Guide</button>
                <button class="suggestion-btn" onclick="sendSuggestion('Tell me about battery efficiency')">Efficiency Info</button>
                <button class="suggestion-btn" onclick="sendSuggestion('Battery maintenance tips')">Maintenance</button>
            </div>

            <div class="model-assist">
                <div class="model-assist-header">
                    <label class="model-assist-toggle" for="modelAssistToggle">
                        <input type="checkbox" id="modelAssistToggle">
                        <span>Include EV parameters for model-assisted advice</span>
                    </label>
                    <div class="assist-controls">
                        <label class="read-aloud-toggle" for="readAloudToggle">
                            <input type="checkbox" id="readAloudToggle">
                            <span>Read responses aloud</span>
                        </label>
                    </div>
                </div>

                <div class="model-assist-form" id="modelAssistForm" hidden>
                    <div class="model-assist-grid">
                        <div class="model-input">
                            <label for="assist-soc">SOC (%)</label>
                            <input type="number" step="0.1" id="assist-soc" placeholder="e.g. 75" data-model-field="soc" data-label="SOC (%)">
                        </div>
                        <div class="model-input">
                            <label for="assist-voltage">Voltage (V)</label>
                            <input type="number" step="0.1" id="assist-voltage" placeholder="e.g. 360" data-model-field="voltage" data-label="Voltage (V)">
                        </div>
                        <div class="model-input">
                            <label for="assist-current">Current (A)</label>
                            <input type="number" step="0.1" id="assist-current" placeholder="e.g. 120" data-model-field="current" data-label="Current (A)">
                        </div>
                        <div class="model-input">
                            <label for="assist-battery-temp">Battery Temp (째C)</label>
                            <input type="number" step="0.1" id="assist-battery-temp" placeholder="e.g. 32" data-model-field="battery_temp" data-label="Battery Temp (째C)">
                        </div>
                        <div class="model-input">
                            <label for="assist-ambient-temp">Ambient Temp (째C)</label>
                            <input type="number" step="0.1" id="assist-ambient-temp" placeholder="e.g. 25" data-model-field="ambient_temp" data-label="Ambient Temp (째C)">
                        </div>
                        <div class="model-input">
                            <label for="assist-duration">Charging Duration (min)</label>
                            <input type="number" step="0.1" id="assist-duration" placeholder="e.g. 45" data-model-field="duration" data-label="Charging Duration (min)">
                        </div>
                        <div class="model-input">
                            <label for="assist-degradation">Degradation Rate (%)</label>
                            <input type="number" step="0.1" id="assist-degradation" placeholder="e.g. 5" data-model-field="degradation" data-label="Degradation Rate (%)">
                        </div>
                        <div class="model-input">
                            <label for="assist-mode">Charging Mode</label>
                            <select id="assist-mode" data-model-field="mode" data-label="Charging Mode">
                                <option value="">Select mode</option>
                                <option>Fast</option>
                                <option>Normal</option>
                                <option>Slow</option>
                            </select>
                        </div>
                        <div class="model-input">
                            <label for="assist-efficiency">Efficiency (%)</label>
                            <input type="number" step="0.1" id="assist-efficiency" placeholder="e.g. 92" data-model-field="efficiency" data-label="Efficiency (%)">
                        </div>
                        <div class="model-input">
                            <label for="assist-battery-type">Battery Type</label>
                            <select id="assist-battery-type" data-model-field="battery_type" data-label="Battery Type">
                                <option value="">Select type</option>
                                <option>Li-ion</option>
                                <option>LiFePO4</option>
                            </select>
                        </div>
                        <div class="model-input">
                            <label for="assist-cycles">Charging Cycles</label>
                            <input type="number" id="assist-cycles" placeholder="e.g. 320" data-model-field="cycles" data-label="Charging Cycles">
                        </div>
                        <div class="model-input">
                            <label for="assist-ev-model">EV Model</label>
                            <select id="assist-ev-model" data-model-field="ev_model" data-label="EV Model">
                                <option value="">Select model</option>
                                <option>Model A</option>
                                <option>Model B</option>
                                <option>Model C</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    Hello! I'm EVBot, your AI-powered EV battery advisor. I can help you with battery maintenance, charging strategies, efficiency tips, and more. What would you like to know?
                </div>
            </div>

            <div class="chat-input-container">
                <input
                    type="text"
                    class="chat-input"
                    id="chatInput"
                    placeholder="Ask me anything about EV batteries..."
                    onkeypress="handleKeyPress(event)"
                />
                <button class="send-button" id="sendButton" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const modelAssistToggle = document.getElementById('modelAssistToggle');
    const modelAssistForm = document.getElementById('modelAssistForm');
    const readAloudToggle = document.getElementById('readAloudToggle');

    const MODEL_FIELDS = [
        'soc', 'voltage', 'current', 'battery_temp', 'ambient_temp',
        'duration', 'degradation', 'mode', 'efficiency',
        'battery_type', 'cycles', 'ev_model'
    ];

    let availableVoices = [];

    function loadVoices() {
        if (!('speechSynthesis' in window)) {
            return;
        }
        availableVoices = window.speechSynthesis.getVoices();
    }

    if ('speechSynthesis' in window) {
        loadVoices();
        window.speechSynthesis.addEventListener('voiceschanged', loadVoices);
    }

    function selectVoice() {
        if (!availableVoices.length) {
            return null;
        }

        const englishVoice = availableVoices.find(voice => voice.lang && voice.lang.toLowerCase().startsWith('en'));
        return englishVoice || availableVoices[0];
    }

    function speakResponse(text) {
        if (!readAloudToggle || !readAloudToggle.checked) {
            return;
        }

        if (!text || !('speechSynthesis' in window)) {
            return;
        }

        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        const voice = selectVoice();
        if (voice) {
            utterance.voice = voice;
        }
        window.speechSynthesis.speak(utterance);
    }

    if (readAloudToggle && 'speechSynthesis' in window) {
        readAloudToggle.addEventListener('change', () => {
            if (!readAloudToggle.checked) {
                window.speechSynthesis.cancel();
            }
        });
    }
 
    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function collectModelPayload() {
        const payload = {};
        const missing = [];

        MODEL_FIELDS.forEach((key) => {
            const input = document.querySelector(`[data-model-field="${key}"]`);
            if (!input) return;

            const value = input.value.trim();
            if (!value) {
                missing.push(input.getAttribute('data-label') || key);
                return;
            }
            payload[key] = value;
        });

        if (missing.length) {
            throw new Error(`Please complete: ${missing.join(', ')}`);
        }

        return payload;
    }

    if (modelAssistToggle) {
        modelAssistToggle.addEventListener('change', () => {
            modelAssistForm.hidden = !modelAssistToggle.checked;
        });
    }
 
    function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        addMessage(message, true);
        chatInput.value = '';
        sendButton.disabled = true;

        let payload = null;
        if (modelAssistToggle && modelAssistToggle.checked) {
            try {
                payload = collectModelPayload();
            } catch (error) {
                addMessage(error.message, false);
                sendButton.disabled = false;
                chatInput.focus();
                return;
            }
        }

        const body = payload ? { message, payload } : { message };

        fetch('/api/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(body)
        })
        .then(response => response.json())
        .then(data => {
            addMessage(data.response, false);
            speakResponse(data.response);
            sendButton.disabled = false;
            chatInput.focus();
        })
        .catch(error => {
            addMessage('Sorry, I encountered an error. Please try again.', false);
            sendButton.disabled = false;
            chatInput.focus();
        });
    }

    function sendSuggestion(text) {
        chatInput.value = text;
        sendMessage();
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    chatInput.focus();
</script>

</body>
</html>
